# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовыми компонентами
- src/components/models/ — папка с JS моделями
- src/models/base/ — папка с базовыми моделями
- src/types — папка с типами

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Перед установкой и запуском проекта необходимо проверить наличие файла .env с ключом `API_ORIGIN`, который указывает на адрес сервера API:

```
API_ORIGIN=https://example.com
```

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Общая концепция работы приложения

Приложение основано на упрощенной версии шаблона проектирования MVP. В данном контексте все приложение содержит общий Presenter, который координирует работу всех View и Model через событийно-ориентированный подход, используя механизм сообщений, которые возникают в результате определенных событий внутри отображений и моделей.


## Типы данных

### IProductItem
Интерфейс описания товара

```ts
export interface IProductItem {
	id: string;
	description: string;
	image: string;
	title: string;
	category: ProductItemCategory;
	price: number;
}

export type ProductItemCategory =
	| 'софт-скил'
	| 'другое'
	| 'дополнительное'
	| 'кнопка'
	| 'хард-скил'
	| string;
```

### IOrder
Интерфейс описания заказа

```ts
export type IOrder = {
	payment: string;
	address: string;
	email: string;
	phone: string;
	items: IProductItem[];
};

```
### IOrderPayload
Интерфейс описания заказа в формате API

```ts
export interface IOrderPayload {
	payment: string;
	address: string;
	email: string;
	phone: string;
	items: string[];
	total: number;
}

```
### IOrderResponse
Интерфейс описания успешного ответа от сервера при отправке заказа

```ts
export interface IOrderResponse {
	id: string;
	total: number;
}
```
### IListResponse
Интерфейс для ответа от сервера при запросе списка данных типа `T`

```ts
export type IListResponse<T> = {
	total: number;
	items: T[];
};
```
## Базовые и связующие блоки 

### HttpClient
Базовый http-клиент.Служит прослойкой для оформления запросов. Создает вариант `Api` с установленным baseUrl.

#### getProducts
Метод получения списка всех продуктов с сервера
#### submitOrder
Метод отправки заказа на сервер

### Базовый класс `EventEmitter`

Обеспечивает работу событий. Его функции: возможность установить и снять слушателей событий, вызвать слушателей при возникновении события

Реализует интерфейс `IEvents`, содержащий методы on, emit и trigger.
Для удобства в проекте используется интерфейс `IEventEmitter`, повторяющий `IEvents`, но содержащий фиксированный набор возможных событий в качестве типа аргумента `event`

| Название события | Описание | Параметры |
| --- | --- | --- |
| `active-product-updated` | Событие обновления активного продукта | - |
| `close-modal` | Событие закрытия модалки | - |
| `close-success` | Событие закрытия окна успеха | - |
| `current-product-updated` | Событие обновления текущего продукта | - |
| `open-basket` | Событие открытия корзины | - |
| `open-contacts-form` | Событие открытия формы контактов | - |
| `open-order-form` | Событие открытия формы заказа | - |
| `open-product` | Событие открытия продукта | id: string |
| `open-success` | Событие открытия окна успеха | - |
| `order-field:input` | Событие обновления поля заказа | field: keyof IOrder, value: any |
| `order-updated` | Событие обновления заказа | - |
| `order-errors-updated` | Событие обновления ошибок заказа | - |
| `product-list-updated` | Событие обновления списка продуктов | - |
| `remove-from-cart` | Событие удаления продукта из корзины | id: string |
| `toggle-active-product` | Событие переключения активного продукта | - |
| `submit:contacts` | Событие отправки формы контактов | - |
| `order-updated:${keyof IOrder}` | Событие обновления поля заказа | value: unknown (фактически поле IOrder, соответствующее ключу) |

### Абстрактный класс `AbstractModel`

Абстрактный класс для создания конкретных моделей с типом `T`. 
- В качестве параметра конструктора принимает `IEventEmitter`. 
- Имеет абстрактный метод `reset()` для сброса состояния
- Имеет метод `setValue(value: T)` для обновления текущего значения 


### Абстрактный класс `Component` 

Абстрактный класс для создания конкретных `view`. Хранит html-элемент и эмиттер событий
- В качестве параметра конструктора принимает `HTMLElement` и `IEventEmitter`. 
- Имеет метод `getElement()` для отдачи html-элемента



## Модели данных (Model)

### Класс `OrderModel`


Служит для реализации модели заказа `IOrder`. Отвечает за все действия, связанные с конкретным объектом заказа. Отправляет наружу события, связанные с изменением заказа.

Имеет:
* Поле `errors` для хранения ошибок
* Метод `updateField` для обновления конкретного поля
* Метод `validateOrder()` для валидации части заказа, связанной с оплатой
* Метод `validateContacts()` для валидации части заказа, связанной с контактами
* Метод `toOrderPayload()` для конвертации модели в формат передачи данных заказа по API
* Метод `updateErrors()` для обновления списка ошибок
* Метод `isInCart()` для проверки наличия товара в заказе
* Метод `toggleProduct()` для добавления или удаления продукта из корзины
* Геттер `total` для получения сумм заказа


### Класс `ActiveProductModel`
Служит для реализации модели текущего выбранного продукта `IProductItem | null`

* Наследует `AbstractModel`, при обновлении данных эмитит событие `active-product-updated`

### Класс `ProductListModel`
Служит для реализации модели списка доступных продуктов `IProductItem[]`
* Наследует `AbstractModel`, при обновлении данных эмитит событие `product-list-updated`


## Отображения (View)
Все отображения наследуют абстрактный класс `Component`
### PageComponent
  Компонент страницы. Объединяет элементы модалки и кнопки корзины

Имеет:
* Метод `updateCounter` для обновления счетчика корзины


### BasketComponent


Компонент отображения корзины

Имеет:
* Метод `updateContent` для обновления списка продуктов
* Метод `updateTotal` для обновления стоимости товаров


### ProductCard

Абстрактный класс для карточек продуктов. Используется как базовый класс для создания других карточек продуктов. 

Имеет:
* Поля `titleElement` и `priceElement` для обображения названия и стоимости продукта.
* Метод `update` для установки значений из конкретного продукта
* Геттер `id` для получения id продукта

ID продукта хранится в самом элементе в виде data-аттрибута


### ProductWithImageCard
Абстрактный класс для карточек, имеющих изображение товара. Наследуется от ProductCard и добавляет поля `imageElement` и `categoryTitleElement` для изображения и категории товара.

Помимо этих полей, имеет:
* Поле `categoryClassMap`, являющееся объектом, содержащим заголовок категории в качетсве ключа и часть css-селектора в качестве значения. Служит для составления правильного css-класса для каждой категории.


### ProductCatalogCard
Компонент карточки товара в каталоге. Полностью наследует ProductWithImageCard.

При нажатии на себя эмитит событие `open-product`


### ProductPreviewCard
Компонент карточки с подробностями товара и кнопкой добавления в корзину. Наследует ProductWithImageCard. 

При нажатии на кнопку эмитит событие `toggle-active-product`

Имеет:
* Поле `cardButton` — кнопка добавления в корзину или удаления из корзины.
* Поле `cardTextElement` — элемент с текстом описания продукта
* Поле `modalContainer` — родительский контейнер, в котором будет отображаться модальное окно
* Метод `updateButtonText()`. Принимает значение `isInCart: boolean`, в зависимости от которого подставляет нужный текст в кнопку


### ProductBasketCard
Компонент карточки товара в корзине. Наследует ProductCard

По нажатию на кнопку удаления эмитит событие `remove-from-cart`

Имеет:
* Поле `indexElement` — элемент, содержащий индекс продукта в корзине
* Поле `titleElement` — элемент, содержащий заголовок продукта
* Поле `priceElement` — элемент, содержащий цену продукта
* Поле `removeButton` — кнопка, удаляющая продукт из корзины

### ProductGallery
  Компонент галереи доступных продуктов. 

  Имеет:
  * Метод `updateContent(list: HTMLElement[])` — подставляет список html-элементов, служит для обновления списка продуктов

### OrderFormComponent

Компонент формы заказа.

Имеет:
* Поле `cashButton` — кнопка-переключатель для режиме оплаты наличными
* Поле `cardButton` —  кнопка-переключатель для режиме оплаты картой
* Поле `submitButton` — кнопка отправки формы
* Поле `addressInput` — поле ввода адреса
* Поле `errorsElement` — элемент для хранения ошибок
* Метод `updatePayment` — обновляет состояние переключателя спосоа оплаты
* Метод `updateAddress` — обновляет значение адреса
* Метод `updateErrors` — обновляет список ошибок
* Метод `updateSubmitButtonState` — обновляет состояние кнопки отправки формы (делает ее доступной или недоступной для нажатия)

### ContactsFormComponent
 Компонент формы контактов

 Имеет:
* Поле `submitButton` — кнопка отправки формы
* Поле `emailInput` — Поле ввода эл. почты
* Поле `phoneInput` — Поле ввода телефона
* Поле `errorsElement` — элемент для хранения ошибок
* Метод `updatePhone` — обновляет значение поля ввода телефона
* Метод `updateEmail` — обновляет значение поля ввода эл. почты
* Метод `updateSubmitButtonState` — обновляет состояние кнопки отправки формы (делает ее доступной или недоступной для нажатия)
* Метод `updateErrors` — обновляет список ошибок
 

### SuccessComponent
Компонент окна-уведомления об успешной отправке заказа

Имеет:
* Поле `descriptionElement` — описание результата 
* Поле `closeButton` — кнопка закрытия
* Метод `updateTotal` — обновляет описание заказа


## Презентер

### Класс `AppPresenter`
Основной презентер приложения. Связывает логику моделей с view-компонентами посредством event-эмиттера. Инициируется при открытии страницы.

Логика работы:
1. При инициализации создается эмиттер событий
2. Создаются представления и связываются с html-элементами. Создаются все модели данных. В модели и представления передается эмиттер.
3. В эмиттере создаются слушатели, связывающие работу приложения:

      
      
    - 3.1. При событии обновления списка продуктов, для каждого из объекта продукта создается компонент катологовой карточки. `ProductGallery` принимает список карточек в своем методе `update`
      
    - 3.2. При событии открытия продукта находится нужный продукт по id, затем модель текущего выбранного продукта принимает значение этого продукта. Модель эмитит событие о смене выбранного продукта.
      
    - 3.3. По событию о смене выбранного продукта компонент `ProductPreviewCard` обновляет свое значение на значение выбранного продукта и затем рендерится в компонент модального окна. 
      
    - 3.4. По событию переключения текущего продукта оно попадает в метод `toggleProduct` модели заказа. Модель эмитит события об обновлении своего списка продуктов.
      
    - 3.5. По событию обновлению списка продуктов в заказе обновляется компонент счетчика (через `updateCounter`), обновляется текст кнопки в карточке выбранного продукта(`updateButtonText`), обновляется содержимое корзины (`updateContent`) и счетчик стоимости внутри корзины (`updateTotal`).
      
    - 3.6. По событию открытия корзины в модальное окно рендерится элемент компонента корзины (`BasketComponent`)
      
    - (см. 3.1)
      
    - 3.8. По событию открытия формы оплаты в модальное окно рендерится элемент формы оплаты (`OrderFormComponent`)
      
    - 3.9. По обновлению любого из полей заказа обновляется соответствующее поле модели заказа. При этом, если это поле `payment` или `address`, происходит валидация формы заказа. Если это поле `email` или `phone`, происходит валидация формы контактов. Если это поле `payment`,  обновляется так же состояние переключателя способа оплаты в форме оплаты (`updatePayment`)
      
    - 3.9.1 При валидации происходит обновление состояние кнопки представления соответствующей формы.
      
    - 3.10. При изменении модели заказа очищается список ошибок.
      
    - 3.11. По событию открытия формы контактов в модальное окно рендерится элемент формы контактов (`ContactsFormComponent`)
      
    - 3.12. При событии отправки формы контактов вызывается `submitOrder` c текущей моделью заказа, переведенной в API-формат (`toOrderPayload`). 
      
        - При успешном ответе в модальное окно подставляется элемент окна об успешном заказе. В окно об успешном заказе подставляется значение суммы заказа (`updateTotal`) из ответа сервера. Состояние модели заказа сбрасывается.
      
        - В случае ошибки, в форму контактов подставляется ошибка с сервера.
      
    - 3.13. При закрытии окна об успешном заказе модальное окно очищается и закрывается.

4. Вызывается метод getProducts и подставляет полученный список продуктов в модель списка продуктов. Модель при этом эмитит событие `product-list-updated`. В случае ошибки, выводится alert c сообщением об ошибке

Таким образом, презентер инициирует все модели и представления, а затем создает связи взаимодействия между ними через общий эмиттер событий